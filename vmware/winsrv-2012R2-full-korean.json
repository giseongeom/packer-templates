{
    "variables": {
        "floppy_data": "winsrv/Win_Svr_2012_R2_DataCtr_Full_Korean/Autounattend.xml,scripts/configure-windows7.ps1",
        "win_media": "Win_Svr_2012_R2_DataCtr_Full_Korean",
        "iso_path": "e:/iso/Microsoft/WS2012R2/SW_DVD9_Windows_Svr_Std_and_DataCtr_2012_R2_64Bit_Korean_-4_MLF_X19-82907.ISO",
        "iso_md5": "DB3854DB7A09FA229901719C00E9000E"
    },
    "builders": [
        {
            "type": "vmware-iso",
            "disable_vnc": true,
            "vm_name": "{{user `win_media`}}-{{isotime \"20060102-1504\"}}",
            "output_directory": "./output-vmware-iso/{{ timestamp }}-{{user `win_media`}}-{{isotime \"20060102\"}}",
            "communicator": "winrm",
            "disk_type_id": 0,
            "disk_size": 149504,
            "floppy_files": "{{user `floppy_data`}}",
            "guest_os_type": "windows8srv-64",
            "iso_url": "{{user `iso_path`}}",
            "iso_checksum_type": "md5",
            "iso_checksum": "{{user `iso_md5`}}",
            "winrm_username": "administrator",
            "winrm_password": "vagrant",
            "winrm_timeout": "6h",
            "headless": false,
            "skip_compaction": true,
            "keep_registered": false,
            "shutdown_command": "C:/Windows/temp/packer_shutdown.cmd",
            "shutdown_timeout": "1h",
            "cpus": 2,
            "memory": 8192,
            "usb": true,
            "Version": 14,
            "network": "nat",
            "network_adapter_type": "e1000e",
            "disk_adapter_type": "lsisas1068",
            "cdrom_adapter_type": "sata"
        }
    ],
    "provisioners": [
        {
            "type": "powershell",
            "pause_before": "15s",
            "scripts": [
                "./scripts/disable-autologin.ps1"
            ]
        },
        {
            "type": "windows-restart",
            "pause_before": "15s"
        },
        {
            "type": "powershell",
            "pause_before": "15s",
            "scripts": [
                "./scripts/install-ndp45.ps1"
            ]
        },
        {
            "type": "windows-restart",
            "pause_before": "15s"
        },
        {
            "type": "powershell",
            "pause_before": "15s",
            "scripts": [
                "./scripts/install-wmf5.ps1"
            ]
        },
        {
            "type": "windows-restart",
            "pause_before": "15s"
        },
        {
            "type": "powershell",
            "pause_before": "15s",
            "scripts": [
                "./scripts/install-chocolatey.ps1",
                "./scripts/install-KB2999226.ps1"
            ]
        },
        {
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "scripts": [
                "./scripts/install-ps-modules.ps1",
                "./scripts/install-vs2017redist.ps1"
            ]
        },
        {
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "pause_before": "10s",
            "scripts": [
                "./scripts/install-guest-tools-on-win7.ps1"
            ]
        },
        {
            "type": "windows-restart",
            "pause_before": "15s"
        },
        {
            "type": "file",
            "source": "./winsrv/{{user `win_media`}}/sysprep/",
            "destination": "c:/windows/temp/sysprep"
        },
        {
            "type": "file",
            "source": "./scripts/packer_shutdown_win10.cmd",
            "destination": "c:/windows/temp/packer_shutdown.cmd"
        },
        {
            "type": "file",
            "source": "./scripts/SetupComplete_win10.cmd",
            "destination": "c:/windows/setup/scripts/SetupComplete.cmd"
        },
        {
            "pause_before": "30s",
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "inline": [
                "Write-Output 'Installing KB3021910..........'",
                "cd c:/windows/temp",
                "wget.exe -nd -nH -q -O Windows8.1-KB3021910-x64.msu https://download.microsoft.com/download/7/7/4/77476115-26DA-42FC-B00F-031D2BB3740F/Windows8.1-KB3021910-x64.msu",
                "Start-Process -wait wusa.exe -ArgumentList 'C:\\Windows\\temp\\Windows8.1-KB3021910-x64.msu /extract:C:\\Windows\\temp\\KB3021910' -NoNewWindow",
                "Start-Process -wait dism.exe -ArgumentList '/online /add-package /norestart /quiet /PackagePath:C:\\Windows\\temp\\KB3021910\\Windows8.1-KB3021910-x64.cab' -NoNewWindow",
                "exit 0"
            ]
        },
        {
            "pause_before": "30s",
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "inline": [
                "Write-Output 'Installing KB3172614..........'",
                "cd c:/windows/temp",
                "wget.exe -nd -nH -q -O Windows8.1-KB3172614-x64.msu https://download.microsoft.com/download/A/8/6/A8686706-78A3-4AC9-ABD2-64DC20A4581F/Windows8.1-KB3172614-x64.msu",
                "Start-Process -wait wusa.exe -ArgumentList 'C:\\Windows\\temp\\Windows8.1-KB3172614-x64.msu /extract:C:\\Windows\\temp\\KB3172614' -NoNewWindow",
                "Start-Process -wait dism.exe -ArgumentList '/online /add-package /norestart /quiet /PackagePath:C:\\Windows\\temp\\KB3172614\\Windows8.1-KB3172614-x64.cab' -NoNewWindow",
                "exit 0"
            ]
        },
        {
            "pause_before": "30s",
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "inline": [
                "Write-Output 'Installing KB3179574..........'",
                "cd c:/windows/temp",
                "wget.exe -nd -nH -q -O Windows8.1-KB3179574-x64.msu https://download.microsoft.com/download/0/E/3/0E303248-4BCD-49CC-A901-0040B055FC3C/Windows8.1-KB3179574-x64.msu",
                "Start-Process -wait wusa.exe -ArgumentList 'C:\\Windows\\temp\\Windows8.1-KB3179574-x64.msu /extract:C:\\Windows\\temp\\KB3179574' -NoNewWindow",
                "Start-Process -wait dism.exe -ArgumentList '/online /add-package /norestart /quiet /PackagePath:C:\\Windows\\temp\\KB3179574\\Windows8.1-KB3179574-x64.cab' -NoNewWindow",
                "exit 0"
            ]
        },
        {
            "pause_before": "30s",
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "inline": [
                "Write-Output 'Installing KB3185279..........'",
                "cd c:/windows/temp",
                "wget.exe -nd -nH -q -O Windows8.1-KB3185279-x64.msu https://download.microsoft.com/download/6/3/5/635BE005-CC9A-4A7C-B484-7A592054A479/Windows8.1-KB3185279-x64.msu",
                "Start-Process -wait wusa.exe -ArgumentList 'C:\\Windows\\temp\\Windows8.1-KB3185279-x64.msu /extract:C:\\Windows\\temp\\KB3185279' -NoNewWindow",
                "Start-Process -wait dism.exe -ArgumentList '/online /add-package /norestart /quiet /PackagePath:C:\\Windows\\temp\\KB3185279\\Windows8.1-KB3185279-x64.cab' -NoNewWindow",
                "exit 0"
            ]
        },
        {
            "pause_before": "30s",
            "type": "windows-restart"
        },
        {
            "type": "windows-shell",
            "inline": [
                "reg.exe ADD \"HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\WindowsUpdate\\Auto Update\" /v IncludeRecommendedUpdates /d 0 /t REG_DWORD /f"
            ]
        },
        {
            "pause_before": "30s",
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "scripts": [
                "./scripts/install-windows-update-on-win7.ps1"
            ]
        },
        {
            "pause_before": "2m",
            "restart_timeout": "60m",
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "pause_before": "2m",
            "scripts": [
                "./scripts/install-windows-update-on-win7.ps1"
            ]
        },
        {
            "pause_before": "2m",
            "restart_timeout": "30m",
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "pause_before": "2m",
            "scripts": [
                "./scripts/install-windows-update-on-win7.ps1"
            ]
        },
        {
            "pause_before": "1m",
            "restart_timeout": "30m",
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "pause_before": "1m",
            "scripts": [
                "./scripts/install-windows-update-on-win7.ps1"
            ]
        },
        {
            "pause_before": "1m",
            "restart_timeout": "30m",
            "type": "windows-restart"
        },
        {
            "type": "powershell",
            "pause_before": "1m",
            "scripts": [
                "./scripts/install-windows-update-on-win7.ps1"
            ]
        },
        {
            "type": "powershell",
            "inline": [
                "Start-Sleep 10"
            ]
        }
    ],
    "post-processors": []
}